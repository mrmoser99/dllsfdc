/*********************************************************************************************
*
* NewCo Rate Utility - used to get rate cards from mosaic   
*
* Change Log:
*
* 9/4/2020 - MRM Created
**********************************************************************************************/
global without sharing class RateUtility { 
    
//
// Generated by JSON2Apex http://json2apex.herokuapp.com/
//


    
    /*************************************************************************************************
    * 
    * getProgram
	*	
	*************************************************************************************************/
    public static void getProgram( String oracleVendorId){    	
	  								
		try{ 
			string accessToken = getAccessToken();
			
			system.debug('at:' + accessToken);
			
			HttpRequest reqAPI = new HttpRequest();  
			
            //https://apiacc.dllgroup.com/vf/us/v1/partner-insight/Details/447843-0001
            
            string endpoint = 'https://apiacc.dllgroup.com/vf/us/v1/partner-insight/Details/447843-0001';

            system.debug('endpoint is: ' + endpoint);
        	//reqAPI.setEndpoint('https://' + System.Label.ICVDomain + '.dllgroup.com/vf/us/v1/partner-insight/Details/447843-0001');
        	reqAPI.setEndpoint(endpoint); 
            reqAPI.setMethod('GET');   
            reqAPI.setHeader('originatorId', 'MOSAIC');    
            reqAPI.setHeader('messageId', '11115');   
            reqAPI.setHeader('Accept', 'application/json');
            reqAPI.setHeader('Charset', 'UTF-8');
            reqAPI.setHeader('Content-Type', 'application/json');
            reqAPI.setHeader('Authorization', 'Bearer '+ accessToken);
        	reqAPI.setTimeout(120000);
        	
			Http http1 = new Http();
	    	HTTPResponse res1 = http1.send(reqAPI); 
            
            if (test.isRunningTest()){
                String tempResults = '{"olmVendorSiteId":"447843-0001","salesRep": [{"firstName":"Joe","lastName":"Dickinson","IsSecondary":null,"atsUserCode":"10666","phone":"6103865000","olmFndID":"925964","isPrimary":true,"networkUserName":"DICKINSONJ","email":"fmdllqatestevent@dllgroup.com"},{"firstName":"Jay","lastName":"Decker","IsSecondary":true,"atsUserCode":"10607","phone":"6103865808","olmFndID":"905079","isPrimary":null,"networkUserName":"DECKERJ","email":"fmdllqatestevent@dllgroup.com"}],"isTelephoneVerificationRequired":false,"usage": [{"identifiers": [{"sourceSystem":"LOANPATH","identifierValue":"3797-1-BILL_TO","identifierType":"LP_PARTY_SITE_USE_ID"},{"sourceSystem":"ORACLE","identifierValue":"55550699","identifierType":"TCA_PARTY_SITE_USE_ID"},{"sourceSystem":"ORACLE","identifierValue":"8210058","identifierType":"TCA_CUST_ACCT_SITE_USE_ID"},{"sourceSystem":"ORACLE","identifierValue":"47306205","identifierType":"TCA_PARTY_SITE_ID"},{"sourceSystem":"LOANPATH","identifierValue":"3797-1-BILL_TO","identifierType":"LP_CUST_ACCT_SITE_USE_ID"}],"name":"BILL_TO","description":"Bill To"},{"identifiers": [{"sourceSystem":"LOANPATH","identifierValue":"3797-1-PAY_TO","identifierType":"LP_PARTY_SITE_USE_ID"},{"sourceSystem":"LOANPATH","identifierValue":"3797-1-PAY_TO","identifierType":"LP_CUST_ACCT_SITE_USE_ID"}],"name":"PAY_TO","description":"Pay To"}],"ouKey":"DLL","program": [{"overrideSoftCosts":false,"sbuKey":"2","privateLabel": [{"isDefaultInvoice":true,"isDefault":true,"documents":true,"name":"DE LAGE LANDEN FINANCIAL SERVICES, INC.","isDefaultDocument":true,"ID":"1004","invoice":true}],"softCostList": [],"name":"OE_VENDOR","overridePromotions":false,"rateCardId":"1000","ID":"1000","overridePrivateLabel":true}],"isActive":true,"PhoneCountryCode":"","salesSupportRep": [{"firstName":"Justin","lastName":"Conrad","atsUserCode":"C70","phone":"6103865000","olmFndID":"276345","isPrimary":null,"networkUserName":"CONRADJ","email":"fmdllqatestevent@dllgroup.com"}],"legacyId":"","ID":"3797-1","isPassThroughEligible":false,"email":"","isPrimarySite":true,"funding":{"paymentMethodCode":"2","preferredFundingSite":{"funding":{"paymentMethodCode":"","deliveryMethod":""},"address":{"country":"","salesTaxAreaId":"","city":"","postalCode":"","county":"","stateProvince":"","line2":"","line1":""},"partner":{"dba": [{"name":"Verizon Basking Ridge"}],"name":"Verizon Basking Ridge"},"phone":"","identifiers": [{"sourceSystem":"ORACLE","identifierValue":"","identifierType":"VENDOR_SITE_CODE"}],"name":"","ID":""},"maximumPoints":60.000,"deliveryMethod":"1","defaultPoints":0.000,"cpcUsageEligible":false},"address":{"country":"US","salesTaxAreaId":"310350266","city":"BASKING RIDGE","postalCode":"07920-1025","county":"SOMERSET","stateProvince":"NJ","line2":"","line1":"1 VERIZON WAY"},"identifiers": [{"sourceSystem":"ORACLE","identifierValue":"790909","identifierType":"AP_VENDOR_SITE_ID"},{"sourceSystem":"LOANPATH","identifierValue":"3797-1","identifierType":"LP_PARTY_SITE_ID"},{"sourceSystem":"LOANPATH","identifierValue":"3797-1","identifierType":"LP_VENDOR_SITE_ID"},{"sourceSystem":"ORACLE","identifierValue":"60094572","identifierType":"TCA_LOCATION_ID"},{"sourceSystem":"ORACLE","identifierValue":"47306205","identifierType":"TCA_PARTY_SITE_ID"},{"sourceSystem":"ORACLE","identifierValue":"3984608","identifierType":"TCA_CUST_ACCT_SITE_ID"},{"sourceSystem":"LOANPATH","identifierValue":"3797-1","identifierType":"LP_CUST_ACCT_SITE_ID"},{"sourceSystem":"ORACLE","identifierValue":"447843-0001","identifierType":"VENDOR_SITE_CODE"}],"timeStamp":"2020-09-11 01:28:21","isDisqualified":false,"partner":{"preferredCustomerInvoiceDueDate":null,"dba": [{"name":"Verizon Basking Ridge"}],"priorityRating":"","isTelephoneVerificationRequired":false,"isAPHold":false,"identifiers": [{"sourceSystem":"ORACLE","identifierValue":"17204120","identifierType":"AP_VENDOR_ID"},{"sourceSystem":"ICV","identifierValue":"1597355824409275","identifierType":"ICV_PARTY_ID"},{"sourceSystem":"LOANPATH","identifierValue":"3797","identifierType":"LP_PARTY_ID"},{"sourceSystem":"LOANPATH","identifierValue":"3797","identifierType":"LP_VENDOR_ID"},{"sourceSystem":"ORACLE","identifierValue":"44604243","identifierType":"TCA_PARTY_ID"},{"sourceSystem":"LOANPATH","identifierValue":"3797","identifierType":"LP_CUST_ACCT_ID"},{"sourceSystem":"ORACLE","identifierValue":"38622120","identifierType":"TCA_CUST_ACCT_ID"},{"sourceSystem":"ORACLE","identifierValue":"447843","identifierType":"VENDOR_CODE"}],"isSingleApp":false,"isActive":true,"classification": [{"name":"1","description":"Originating Partner"}],"name":"Verizon Basking Ridge","isBookingHold":false,"ID":"3797","isWatchList":false,"olmVendorId":"447843"},"phone":"9802517035","name":"Verizon Basking Ridge","correspondent": [{"firstName":"Joe","lastName":"Dickinson","isAutoSend":true,"correspondenceType": [{"description":"Approval Package","ID":"1"},{"description":"Decline Package","ID":"2"},{"description":"Additional Information Package","ID":"4"}],"email":"fmdllqatestevent@dllgroup.com"},{"firstName":"Jay","lastName":"Decker","isAutoSend":true,"correspondenceType": [{"description":"Approval Package","ID":"1"},{"description":"Decline Package","ID":"2"},{"description":"Additional Information Package","ID":"4"}],"email":"fmdllqatestevent@dllgroup.com"},{"firstName":"Justin","lastName":"Conrad","isAutoSend":true,"correspondenceType": [],"email":"fmdllqatestevent@dllgroup.com"}],"isWatchList":false,"IsUsageEligible":false}';
                processResults(res1);
            }
            else{
                system.debug('List of rate card ids is: ' + processResults(res1));
            }
        }
 		catch (exception e){
 			system.debug(e);
 		}
    }


    /*************************************************************************************************
    * 
    * Process GetProgram Results
 	*	
    *************************************************************************************************/
    public static List<String> processResults(HTTPResponse res1){     

        List<String> results = new List<String>();

        RateCardAccountJSON2Apex result = RateCardAccountJSON2Apex.parse(string.valueOf(res1.getBody()));
        
        system.debug(result.program);
        for (RateCardAccountJSON2Apex.program p:result.program){
            results.add(p.rateCardId); 
        }

        return results;

    }
    
    /*************************************************************************************************
    * 
    * Ratecard Get Access Token - these are different than icv.
	*	
    *************************************************************************************************/
    public static string getAccessToken(){     
    	
    	system.debug('******** getting access token');
    	if (Test.isRunningTest())
    		return string.valueOf(system.now());
    		
    	String client = System.Label.Ratecard_Client;  
    	String secret = System.Label.Ratecard_Client_Secret;  
		HttpRequest req_token = new HttpRequest();        
		
		String tokenEndpoint = System.Label.ICV_tokenendpoint;  
		req_token.setEndpoint(tokenEndpoint);
        req_token.setMethod('POST');        
        req_token.setHeader('content-type', 'application/x-www-form-urlencoded');
        req_token.setHeader('cache-control', 'no-cache');        
        req_token.setBody('client_id='+client+'&client_secret='+secret+'&grant_type=client_credentials');
      
        Http http = new Http(); 
        HTTPResponse res = http.send(req_token);
        //System.debug(res.getBody());
		
		String access_token;

		JSONParser parser = JSON.createParser(res.getBody());
            
        while (parser.nextToken() != null) {
        	if (parser.getCurrentName() == 'access_token') {
            	access_token = parser.getText();
            	//system.debug(parser.getText());
            }
        }
        
       	system.debug('******** returning access token');
        return access_token;
         
    }
    
    
}